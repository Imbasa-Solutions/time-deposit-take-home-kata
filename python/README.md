# Time Deposit Refactoring Kata — Python

Refactor of the provided *time deposit* code into a small API.

## Stack
- **Python 3.12** (recommended)
- FastAPI + Uvicorn
- SQLAlchemy (SQLite by default; Postgres supported)
- Optional: pytest + Testcontainers (Docker) for e2e tests

## Project layout (python/)
```
app/
  main.py                     # FastAPI app & router
  adapters/
    api.py                    # Two endpoints
    persistence.py            # SQLAlchemy models + repository
  application/
    ports.py                  # repository port interface
    services.py               # UpdateBalancesService orchestrator
seed/
  seed_data.py                # dev-only seeding 
tests/
  test_api_e2e.py             # optional e2e test using Testcontainers
time_deposit.py               # original domain 
test_time_deposit.py          # original unit test
requirements.txt
```

## Setup
```bash
cd python
python3.12 -m venv .venv && source .venv/bin/activate
python -m pip install --upgrade pip
pip install -r requirements.txt
```

### Database
- Defaults to **SQLite** at `sqlite:///./app.db` if `DATABASE_URL` is not set.
- Postgres also works; set `DATABASE_URL` (SQLAlchemy URL, e.g. `postgresql+psycopg2://user:pass@localhost:5432/db`).

```bash
# SQLite (default)
export DATABASE_URL="sqlite:///./app.db"
```

### (Optional) Seed data for local testing
This is a dev helper
```bash
python -m seed.seed_data
```

Seeds 6 deposits across rule paths (basic/student/premium, different day thresholds) and a few withdrawals.

## Run the API
```bash
uvicorn app.main:app --reload
```
Open **Swagger** at: http://127.0.0.1:8000/docs  
OpenAPI JSON: http://127.0.0.1:8000/openapi.json

## Endpoints

### 1) `GET /time-deposits`
Returns all deposits.

**Response schema**
```json
[
  {
    "id": 1,
    "planType": "basic",
    "balance": 1234567.0,
    "days": 45,
    "withdrawals": [
      { "amount": 250.0, "date": "2025-01-15" }
    ]
  }
]
```

**curl**
```bash
curl -s http://127.0.0.1:8000/time-deposits | jq
```

### 2) `POST /time-deposits/update-balances`
Calculates monthly interest and persists the new balances.

**Response**
```json
{ "updated": 6 }
```

**curl**
```bash
curl -s -X POST http://127.0.0.1:8000/time-deposits/update-balances | jq
```

## Business rules
- No interest for the **first 30 days** for any plan.
- **Basic:** 1% p.a. (applied monthly) after day 30.
- **Student:** 3% p.a. (applied monthly) **until day 365**; no interest from day 366.
- **Premium:** 5% p.a. (applied monthly) **starting after day 45**.
- Balances rounded to **2 decimals** (same as original code).

## Design notes (Hexagonal)
- **Domain**: `time_deposit.py` left intact.
- **Application**: `UpdateBalancesService` orchestrates *fetch → calculate → persist* and is easy to extend.
- **Adapters**:
  - `adapters/persistence.py` implements the repository port and DB models (`timeDeposits`, `withdrawals`).
  - `adapters/api.py` holds the two REST endpoints.
- **OpenAPI** is generated by FastAPI; only the two required routes are exposed.

> **Assumptions:** Input validation & error handling are out of scope per brief. Comments in code call out any ambiguous choices.

## Tests
Requires Docker running for Testcontainers.
```bash
pytest -q tests/test_api_e2e.py
```
What the e2e test does:
1. Spins up a Postgres 16 container.
2. Binds the app to it (`DATABASE_URL`).
3. Seeds two deposits + a withdrawal.
4. Calls **GET** and **POST** endpoints.
5. Asserts balances update exactly per rules.